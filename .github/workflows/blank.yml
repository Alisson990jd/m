name: SSH via Ngrok com Sudo (Token Fixo)
on:
  push:
    branches:
      - main

jobs:
  ssh-ngrok:
    runs-on: ubuntu-latest
    steps:
      - name: Configurar usuário SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo useradd -m -s /bin/bash devuser
          echo "devuser:password123" | sudo chpasswd
          echo "devuser ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/devuser > /dev/null

      - name: Iniciar serviço SSH
        run: sudo service ssh start

      - name: Instalar ngrok com link personalizado
        run: |
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz 
          tar -xvzf ngrok-v3-stable-linux-amd64.tgz  # Extrai corretamente o arquivo .tgz [[1]]
          sudo mv ngrok /usr/local/bin/
          ngrok config add-authtoken 1vgZrCA9yJDURy3OK1gNbS2G610_3CX2e2bqT4Ee88uMBk5he

      - name: Iniciar túnel SSH com ngrok
        uses: tmshkr/ngrok-ssh@v1
        with:
          ssh-port: 22
          ssh-user: devuser
          ssh-password: password123
          enable-sudo: true
          SET_RANDOM_PASSWORD: false
          SSH_PORT: 2222
          USE_GITHUB_ACTOR_KEY: true
          WAIT_FOR_CONNECTION: false

      - name: Manter o contêiner em execução
        run: sleep 1000000
