name: SSH via Ngrok (API Direta)
on:
  push:
    branches:
      - main

jobs:
  ssh-ngrok:
    runs-on: ubuntu-latest
    steps:
      - name: Configurar usu√°rio SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo useradd -m -s /bin/bash devuser
          echo "devuser:password123" | sudo chpasswd
          echo "devuser ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/devuser > /dev/null

      - name: Iniciar servi√ßo SSH
        run: sudo service ssh start

      - name: Instalar ngrok e configurar token
        run: |
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz 
          tar -xvzf ngrok-v3-stable-linux-amd64.tgz
          sudo mv ngrok /usr/local/bin/
          export NGROK_AUTHTOKEN=1vgZrCA9yJDURy3OK1gNbS2G610_3CX2e2bqT4Ee88uMBk5he

      - name: Criar t√∫nel TCP com ngrok via API
        run: |
          # Iniciar ngrok em segundo plano
          ngrok tcp 22 --authtoken=$NGROK_AUTHTOKEN &

          # Aguardar o t√∫nel ser criado
          sleep 10

          # Obter o endere√ßo exposto
          PUBLIC_URL=$(curl -s -u "$NGROK_AUTHTOKEN:" http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')

          echo "üîó Conecte-se via SSH em: ssh devuser@${PUBLIC_URL#*@} -p ${PUBLIC_URL##*:}"

      - name: Manter o cont√™iner em execu√ß√£o
        run: sleep 1000000
